<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Giriş Yap</title>

  <!-- Harici style.css -->
  <link rel="stylesheet" href="style.css">
  <script src="config.js"></script>
</head>

<body class="login-page">
  <div class="login-card">
    <img id="brandLogo" class="logo" alt="Logo">
    <h2 id="brandTitle">Giriş Paneli</h2>

    <div class="form-group">
      <label>Email</label>
      <input id="email" type="email" placeholder="E-mail adresiniz">
    </div>

    <div class="form-group">
      <label>Şifre</label>
      <input id="password" type="password" placeholder="Şifreniz">
    </div>

    <button class="btn-login" onclick="login()">Giriş Yap</button>
    <div id="errorBox" class="login-error"></div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    (async () => {
      await window.waitConfig();
      document.getElementById("brandLogo").src = CONFIG.logo;
      document.getElementById("brandTitle").innerText =
        CONFIG.brandName + " Stok Paneli";
    })();

    const db = supabase.createClient(
      "https://jarsxtpqzqzhlshpmgot.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcnN4dHBxenF6aGxzaHBtZ290Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyODExMTcsImV4cCI6MjA3Nzg1NzExN30.98oYONSkb8XSDrfGW2FxhFmt2BLB5ZRo3Ho50GhZYgE"
    );

    async function login() {
      await window.waitConfig();

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const errorBox = document.getElementById("errorBox");
      errorBox.style.display = "none";

      const { data, error } = await db.auth.signInWithPassword({ email, password });

      if (error) {
        errorBox.textContent = "Hatalı email veya şifre!";
        errorBox.style.display = "block";
        return;
      }

      const meta = (data.user.user_metadata ?? data.user.raw_user_meta_data) || {};

      if (!meta.firma || meta.firma.toLowerCase() !== CONFIG.brand.toLowerCase()) {
        errorBox.textContent = "Bu panele sadece " + CONFIG.brandName + " kullanıcıları girebilir!";
        errorBox.style.display = "block";
        await db.auth.signOut();
        return;
      }

      localStorage.setItem("firma", meta.firma.toLowerCase());
      localStorage.setItem("rol", meta.rol || "");
      localStorage.setItem("session", JSON.stringify(data.session));
      location.href = "index.html";
    }
    window.login = login;
  </script>

</body>
</html>
